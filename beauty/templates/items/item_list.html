{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- ページヘッダー -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-1 text-dark">
                        <i class="fas fa-list me-2"></i>{{ page_title }}アイテム一覧
                    </h2>
                    <p class="text-muted mb-0">{{ page_description }}登録したコスメアイテム一覧を表示します</p>
                </div>
                <div>
                    <a href="{% url 'beauty:item_new' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>新規追加
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 期限タブ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <ul class="nav nav-tabs nav-tabs-custom border-0" id="expiryTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'all' %}active{% endif %}" href="?tab=all">
                                すべて <span class="badge bg-secondary ms-1">{{ tab_counts.all }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'expired' %}active{% endif %}" href="?tab=expired">
                                期限切れ <span class="badge bg-danger ms-1">{{ tab_counts.expired }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'week' %}active{% endif %}" href="?tab=week">
                                7日以内 <span class="badge bg-warning ms-1">{{ tab_counts.week }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'biweek' %}active{% endif %}" href="?tab=biweek">
                                14日以内 <span class="badge bg-warning ms-1">{{ tab_counts.biweek }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'month' %}active{% endif %}" href="?tab=month">
                                30日以内 <span class="badge bg-info ms-1">{{ tab_counts.month }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if current_tab == 'safe' %}active{% endif %}" href="?tab=safe">
                                余裕あり <span class="badge bg-success ms-1">{{ tab_counts.safe }}</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索・フィルタエリア -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form id="searchForm" method="GET">
                        <!-- 検索バー -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="search" placeholder="商品名で検索..."
                                        value="{{ current_search }}">
                                    <button class="btn btn-outline-primary" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" name="sort" id="sortSelect">
                                    <option value="expires_on" {% if current_sort == 'expires_on' %}selected{% endif %}>
                                        期限が近い順</option>
                                    <option value="-expires_on" {% if current_sort == '-expires_on' %}selected{% endif %}>
                                        期限が遠い順</option>
                                    <option value="-created_at" {% if current_sort == '-created_at' %}selected{% endif %}>
                                        登録日が新しい順</option>
                                    <option value="created_at" {% if current_sor == 'created_at' %}selected{% endif %}>
                                        登録日が古い順</option>
                                </select>
                            </div>
                        </div>

                        <!-- フィルタドロワー -->
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">大カテゴリ</label>
                                <select class="form-select" id="majorCategory">
                                    <option value="">選択してください</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">中カテゴリ</label>
                                <select class="form-select" id="middleCategory" disabled>
                                    <option value="">選択してください</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">小カテゴリ</label>
                                <select class="form-select" id="minorCategory" disabled>
                                    <option value="">選択してください</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ステータス</label>
                                <select class="form-select" name="status" id="statusSelect">
                                    <option value="">すべて</option>
                                    <option value="using" {% if current_status == 'using' %}selected{% endif %}>使用中
                                    </option>
                                    <option value="finished" {% if current_status == 'finished' %}selected{% endif %}>使用終了
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" id="applyFilters">
                                    <i class="fas fa-filter me-1"></i>フィルタを適用
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="clearFilters">
                                    <i class="fas fa-times me-1"></i>クリア
                                </button>
                            </div>
                        </div>

                        <!-- 隠しフィールド -->
                        <input type="hidden" name="tab" value="{{ current_tab }}">
                        <input type="hidden" name="product_type" id="productTypeInput">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- アイテム一覧 -->
    <div class="row">
        {% if items_with_data %}
        {% for item_data in items_with_data %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card item-card h-100 shadow-sm"
                onclick="location.href='{% url 'beauty:item_detail' item_data.item.id %}'" style="cursor: pointer;">
                <div class="row g-0 h-100">
                    <div class="col-4">
                        {% if item_data.item.image %}
                        <img src="{{ item_data.item.image.url }}" class="img-fluid item-image"
                            alt="{{ item_data.item.name }}">
                        {% else %}
                        <div class="item-image-placeholder d-flex align-items-center justify-content-center">
                            <i class="fas fa-image text-muted fa-2x"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-8">
                        <div class="card-body p-3 d-flex flex-column h-100">
                            <div class="mb-2">
                                <span class="badge badge-category">{{ item_data.item.product_type.name }}</span>
                                <span class="badge badge-status-{{ item_data.item.status }} ms-1">
                                    {% if item_data.item.status == 'using' %}使用中{% else %}使用終了{% endif %}
                                </span>
                            </div>

                            <h6 class="card-title mb-2 text-truncate" title="{{ item_data.item.name }}">
                                {{ item_data.item.name }}
                            </h6>

                            {% if item_data.item.brand %}
                            <p class="text-muted small mb-2">{{ item_data.item.brand }}</p>
                            {% endif %}

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-end">
                                    <div>
                                        <div class="expiry-status expiry-{{ item_data.risk_level }}">
                                            {{ item_data.risk_text }}
                                        </div>
                                        <small class="text-muted">
                                            {% if item_data.days_remaining >= 0 %}
                                            あと{{ item_data.days_remaining }}日
                                            {% else %}
                                            {{ item_data.days_remaining_abs }}日経過
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted d-block">
                                            {{ item_data.item.expires_on|date:"Y/m/d" }}
                                        </small>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-2">アイテムが見つかりません</h5>
                <p class="text-muted mb-4">条件を変更して再度検索してください</p>
                <a href="{% url 'beauty:item_new' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>最初のアイテムを追加
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

    {% block extra_js %}
    <script src="{% static 'js/item-list.js' %}"></script>
    {% endblock %}